#!/usr/bin/php

<?php
if (PHP_SAPI !== 'cli') {
    echo chr(27) . '[34m bin/m' . chr(27) . '[31m  ??? CLI ??????' . chr(27) . '[0m' . PHP_EOL;
    exit(1);
}

try {
    require __DIR__ . '/../app/bootstrap.php';
} catch (Exception $e) {
    $chr = chr(27);
    echo <<<CLI_E
{$chr}[34m CLI 异常
{$chr}[31m文件：{$e->getFile()}
行数：{$e->getLine()}
消息：{$e->getMessage()} 
{$chr}[0m
CLI_E;
    exit(1);
}
try {
    (new Weline\Framework\Console\Cli('M?? CLI', $argv))->run();
    // 运行代码标准程序 php-cs-fixer
    if(is_file(\Weline\Framework\App\Env::extend_dir.'php-cs-fixer-v2.phar')){
        exec('php '.\Weline\Framework\App\Env::extend_dir.'php-cs-fixer-v2.phar fix',$out);
    }else{
        if(DEV)  new \Weline\Framework\App\Exception('标准化代码文件缺失：'.\Weline\Framework\App\Env::extend_dir.'php-cs-fixer-v2.phar');
    }
} catch (Exception $e) {
    $chr = chr(27);
    while ($e) {
        $code = (in_array('getErrorCode', get_class_methods($e))) ? $e->getErrorCode() : '?????';
        echo <<<CLI_E
{$chr}[34m CLI 异常
{$chr}[0m
{$chr}[36m代码
{$code}
{$chr}[0m
{$chr}[31m追踪
{$e->getTraceAsString()}

{$chr}[31m文件{$e->getFile()}
行数{$e->getLine()}
消息{$e->getMessage()}
CLI_E;
        echo "\n\n";
        $e = $e->getPrevious();
    }
    exit(0);
}
